{% extends "base.html" %}

{% block title %} Order Summaries {% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    <script>
        Chart.register(window['chartjs-plugin-annotation']);
    </script>
    <style>
        .element-block{
            width: 90%;
            height: 90%;
        }
        #summary-container{
            padding: 0px;
        }

    </style>
{% endblock %}

{% block content %}
    {{ block_header('Order Summaries') }}
        <div id="summary-container">
        </div>
    {{ block_footer() }}
{% endblock %}

{% block script %}
<script>
  async function loadSummaryTable() {
    const container = document.getElementById('summary-container');
    container.innerHTML = ''; // Clear old stuff

    try {
      const response = await fetch('/api/get_all_summaries');
      const payload = await response.json();

      // Expecting: { labels: { key: "Label", ... }, data: [ { key: value, ... }, ... ] }
      const labels = payload.labels;
      let data = payload.data;

      if (!Array.isArray(data) || typeof labels !== 'object') {
        container.textContent = 'Invalid data format.';
        return;
      }

      // Sort data by "Order Closed" status
      // Priority: blank/none/empty first, then "Open", then "Closed"
      data = data.sort((a, b) => {
        const getOrderClosedValue = (item) => {
          // Find the key that corresponds to "Order Closed"
          const orderClosedKey = Object.keys(labels).find(key => 
            labels[key] === 'Order Closed' || key.toLowerCase().includes('order') && key.toLowerCase().includes('closed')
          );
          
          if (!orderClosedKey) return '';
          
          const value = item[orderClosedKey];
          if (!value || value === '' || value === null || value === undefined) {
            return '';
          }
          return String(value).trim();
        };

        const aValue = getOrderClosedValue(a);
        const bValue = getOrderClosedValue(b);

        // Define sort priority: blank = 0, Open = 1, Closed = 2
        const getSortPriority = (value) => {
          if (!value || value === '') return 0; // blank first
          if (value.toLowerCase() === 'open') return 1; // open second
          if (value.toLowerCase() === 'closed') return 2; // closed last
          return 3; // any other value goes at the end
        };

        const aPriority = getSortPriority(aValue);
        const bPriority = getSortPriority(bValue);

        return aPriority - bPriority;
      });

      const table = document.createElement('table');
      table.style.borderCollapse = 'collapse';
      table.style.width = '100%';

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      // Get the column order from the labels object
      const columnKeys = payload.order ?? Object.keys(labels);
      columnKeys.forEach(key => {
        const th = document.createElement('th');
        th.textContent = labels[key];
        th.style.border = '1px solid black';
        th.style.padding = '6px';
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      data.forEach(item => {
        const row = document.createElement('tr');
        columnKeys.forEach(key => {
          const td = document.createElement('td');
          let value = item[key] ?? '';
          if (key === 'created' && typeof value === 'string') {
            try {
              value = new Date(value).toISOString().split('T')[0];
            } catch {
              // fallback to raw value
            }
          }
          if (typeof value === 'object' && value !== null) {
            value = JSON.stringify(value);
          }
          td.textContent = value;
          td.style.border = '1px solid black';
          td.style.padding = '6px';
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    } catch (err) {
      console.error('Failed to load summary table:', err);
      container.textContent = 'Error loading summary data.';
    }
  }

  // Load on page load
  document.addEventListener('DOMContentLoaded', loadSummaryTable);
</script>

{% endblock %}