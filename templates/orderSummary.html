{% extends "base.html" %}

{% block title %} Order Summaries {% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    <script>
        Chart.register(window['chartjs-plugin-annotation']);
    </script>
    <style>
        .element-block{
            width: 90%;
            height: 90%;
        }
        #summary-container{
            padding: 0px;
        }

    </style>
{% endblock %}

{% block content %}
    {{ block_header('Order Summaries') }}
        <div id="summary-container">
        </div>
    {{ block_footer() }}
{% endblock %}

{% block script %}
<script>
  async function loadSummaryTable() {
    const container = document.getElementById('summary-container');
    container.innerHTML = ''; // Clear old stuff

    try {
      const response = await fetch('/api/get_all_summaries');
      const payload = await response.json();

      // Expecting: { labels: { key: "Label", ... }, data: [ { key: value, ... }, ... ] }
      const labels = payload.labels;
      let data = payload.data;

      if (!Array.isArray(data) || typeof labels !== 'object') {
        container.textContent = 'Invalid data format.';
        return;
      }

      // Sort data by "Order Closed" status
      // Priority: blank/none/empty first, then "Open", then "Closed"
      data = data.sort((a, b) => {
        const getOrderClosedValue = (item) => {
          // Find the key that corresponds to "Order Closed"
          const orderClosedKey = Object.keys(labels).find(key => 
            labels[key] === 'Order Closed' || key.toLowerCase().includes('order') && key.toLowerCase().includes('closed')
          );
          
          if (!orderClosedKey) return '';
          
          const value = item[orderClosedKey];
          if (!value || value === '' || value === null || value === undefined) {
            return '';
          }
          return String(value).trim();
        };

        const aValue = getOrderClosedValue(a);
        const bValue = getOrderClosedValue(b);

        // Define sort priority: blank = 0, Open = 1, Closed = 2
        const getSortPriority = (value) => {
          if (!value || value === '') return 0; // blank first
          if (value.toLowerCase() === 'open') return 1; // open second
          if (value.toLowerCase() === 'closed') return 2; // closed last
          return 3; // any other value goes at the end
        };

        const aPriority = getSortPriority(aValue);
        const bPriority = getSortPriority(bValue);

        return aPriority - bPriority;
      });

      const table = document.createElement('table');
      table.style.borderCollapse = 'collapse';
      table.style.width = '100%';

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      // Get the column order from the labels object
      const columnKeys = payload.order ?? Object.keys(labels);
      columnKeys.forEach(key => {
        const th = document.createElement('th');
        th.textContent = labels[key];
        th.style.border = '1px solid black';
        th.style.padding = '6px';
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      data.forEach(item => {
        const row = document.createElement('tr');
        columnKeys.forEach(key => {
          const td = document.createElement('td');
          let value = item[key] ?? '';
          
          // Special handling for Status Counts column
          if (labels[key] === 'Status Counts' && typeof value === 'object' && value !== null) {
            td.appendChild(createStatusBars(value, item));
          } else {
            if (key === 'created' && typeof value === 'string') {
              try {
                value = new Date(value).toISOString().split('T')[0];
              } catch {
                // fallback to raw value
              }
            }
            if (typeof value === 'object' && value !== null) {
              value = JSON.stringify(value);
            }
            td.textContent = value;
          }
          
          td.style.border = '1px solid black';
          td.style.padding = '6px';
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    } catch (err) {
      console.error('Failed to load summary table:', err);
      container.textContent = 'Error loading summary data.';
    }
  }

  // Create status bars for Status Counts column
  function createStatusBars(statusData, item) {
    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    
    const barsContainer = document.createElement('div');
    barsContainer.style.display = 'flex';
    barsContainer.style.flexDirection = 'row';
    barsContainer.style.gap = '4px';
    barsContainer.style.minWidth = '360px';

    const scrap = statusData.Scrap || 0;
    const awaiting = statusData['Awaiting Functional Test'] || 0;
    const passed = statusData['Passed Initial Diagnosis'] || 0;
    const hasError = statusData._ERROR;
    
    // Get total from board_count if available, otherwise sum the values
    const boardCount = item.board_count || (scrap + awaiting + passed);
    const total = boardCount > 0 ? boardCount : 1; // Avoid division by zero

    const categories = [
      { value: scrap, color: '#dc3545', lightColor: '#f8d7da' },
      { value: awaiting, color: '#007bff', lightColor: '#d1ecf1' },
      { value: passed, color: '#28a745', lightColor: '#d4edda' }
    ];

    categories.forEach(category => {
      // Progress bar container
      const progressBar = document.createElement('div');
      progressBar.style.width = '120px';
      progressBar.style.height = '16px';
      progressBar.style.border = '1px solid #ccc';
      progressBar.style.borderRadius = '3px';
      progressBar.style.overflow = 'hidden';
      progressBar.style.position = 'relative';
      progressBar.style.backgroundColor = hasError ? '#e9ecef' : category.lightColor;

      // Progress fill
      const progressFill = document.createElement('div');
      const percentage = (category.value / total) * 100;
      progressFill.style.width = `${Math.min(percentage, 100)}%`;
      progressFill.style.height = '100%';
      progressFill.style.backgroundColor = hasError ? '#6c757d' : category.color;
      progressFill.style.transition = 'width 0.3s ease';

      // Overlay text
      const overlayText = document.createElement('div');
      overlayText.textContent = `${percentage.toFixed(1)}% (${category.value})`;
      overlayText.style.position = 'absolute';
      overlayText.style.top = '50%';
      overlayText.style.left = '4px';
      overlayText.style.transform = 'translateY(-50%)';
      overlayText.style.fontSize = '11px';
      overlayText.style.fontWeight = 'bold';
      overlayText.style.color = 'white';
      overlayText.style.textShadow = '1px 1px 1px rgba(0,0,0,0.5)';
      overlayText.style.pointerEvents = 'none';

      progressBar.appendChild(progressFill);
      progressBar.appendChild(overlayText);
      barsContainer.appendChild(progressBar);
    });

    container.appendChild(barsContainer);
    if (hasError) {
      const errorDiv = document.createElement('div');
      errorDiv.style.display = 'flex';
      errorDiv.style.alignItems = 'center';
      errorDiv.style.gap = '4px';
      errorDiv.style.marginTop = '2px';
      errorDiv.style.fontSize = '11px';
      errorDiv.style.color = '#dc3545';
      errorDiv.style.fontWeight = 'bold';

      const exclamation = document.createElement('span');
      exclamation.textContent = '⚠️';
      exclamation.style.color = '#dc3545';
      errorDiv.appendChild(exclamation);

      const errorText = document.createElement('span');
      errorText.textContent = statusData._ERROR;
      errorDiv.appendChild(errorText);

      container.appendChild(errorDiv);
    }

    return container;
  }

  // Load on page load
  document.addEventListener('DOMContentLoaded', loadSummaryTable);
</script>
{% endblock %}