{% extends "base.html" %}

{% block title %} Order Summaries {% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    <script>
        Chart.register(window['chartjs-plugin-annotation']);
    </script>
    <style>
        .element-block{
            width: 90%;
            height: 90%;
        }
        #summary-container{
            padding: 0px;
        }

    </style>
{% endblock %}

{% block content %}
    {{ block_header('Order Summaries') }}
        <div id="summary-container">
        </div>
    {{ block_footer() }}
{% endblock %}

{% block script %}
<script>
  async function loadSummaryTable() {
    const container = document.getElementById('summary-container');
    container.innerHTML = ''; // Clear old stuff

    try {
      const response = await fetch('/api/get_all_summaries');
      const payload = await response.json();

      // Expecting: { labels: { key: "Label", ... }, data: [ { key: value, ... }, ... ] }
      const labels = payload.labels;
      const data = payload.data;

      if (!Array.isArray(data) || typeof labels !== 'object') {
        container.textContent = 'Invalid data format.';
        return;
      }

      const table = document.createElement('table');
      table.style.borderCollapse = 'collapse';
      table.style.width = '100%';

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      // Get the column order from the labels object
      const columnKeys = payload.order ?? Object.keys(labels);
      columnKeys.forEach(key => {
        const th = document.createElement('th');
        th.textContent = labels[key];
        th.style.border = '1px solid black';
        th.style.padding = '6px';
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      data.forEach(item => {
        const row = document.createElement('tr');
        columnKeys.forEach(key => {
          const td = document.createElement('td');
          let value = item[key] ?? '';
          if (key === 'created' && typeof value === 'string') {
            try {
              value = new Date(value).toISOString().split('T')[0];
            } catch {
              // fallback to raw value
            }
          }
          if (typeof value === 'object' && value !== null) {
            value = JSON.stringify(value);
          }
          td.textContent = value;
          td.style.border = '1px solid black';
          td.style.padding = '6px';
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    } catch (err) {
      console.error('Failed to load summary table:', err);
      container.textContent = 'Error loading summary data.';
    }
  }

  // Load on page load
  document.addEventListener('DOMContentLoaded', loadSummaryTable);
</script>

{% endblock %}